<?xml version="1.0" encoding="utf-8"?>
<hibernate-mapping assembly="Vokabular.DataEntities" namespace="Vokabular.DataEntities.Database.Entities" xmlns="urn:nhibernate-mapping-2.2">
  <class name="ResourceVersion" table="[ResourceVersion]" abstract="true">
    <id name="Id" column="Id">
      <generator class="identity" />
    </id>
    
    <property name="VersionNumber" not-null="true" />
    
    <property name="Comment" not-null="false" />
    
    <property name="CreateTime" not-null="true" type="UtcDateTime" />

    <many-to-one name="CreatedByUser" class="User" lazy="proxy" not-null="true" />
    
    <many-to-one name="Resource" class="Resource" lazy="proxy" not-null="true" cascade="save-update" />
    
    <many-to-one name="ParentResource" class="Resource" lazy="proxy" not-null="false" />

    <bag name="Snapshots" table="Snapshot_ResourceVersion" inverse="true" lazy="true">
      <key column="ResourceVersion" />
      <many-to-many class="Snapshot" column="Snapshot" />
    </bag>
    

    <joined-subclass table="PageResource" name="PageResource" >
      <key column="ResourceVersionId" />
      
      <property name="Name" not-null="true" />
      <property name="Position" not-null="true" />

      <bag name="Terms" table="PageResource_Term" cascade="save-update" lazy="true">
        <key column="PageResource" />
        <many-to-many class="Term" column="Term" />
      </bag>
    </joined-subclass>

    <joined-subclass table="TextResource" name="TextResource" >
      <key column="ResourceVersionId" />

      <property name="ExternalId" />
      <many-to-one name="BookVersion" class="BookVersionResource" lazy="proxy" />
    </joined-subclass>

    <joined-subclass table="ImageResource" name="ImageResource" >
      <key column="ResourceVersionId" />

      <property name="FileName" not-null="true" />
      <property name="MimeType" not-null="true" />
      <property name="Size" not-null="true" />
    </joined-subclass>

    <joined-subclass table="MetadataResource" name="MetadataResource" >
      <key column="ResourceVersionId" />

      <property name="Title" />
      <property name="SubTitle" />
      <property name="AuthorsLabel" />
      <property name="RelicAbbreviation" />
      <property name="SourceAbbreviation" />
      <property name="PublishPlace" />
      <property name="PublishDate" />
      <property name="PublisherText" />
      <property name="PublisherEmail" />
      <property name="Copyright" />
      <property name="BiblText" />
      <property name="OriginDate" />
      <property name="NotBefore" type="DateTime2" />
      <property name="NotAfter" type="DateTime2" />
      <property name="ManuscriptIdno" />
      <property name="ManuscriptSettlement" />
      <property name="ManuscriptCountry" />
      <property name="ManuscriptRepository" />
      <property name="ManuscriptExtent" />
      <property name="ManuscriptTitle" />
    </joined-subclass>

    <joined-subclass table="AudioResource" name="AudioResource" >
      <key column="ResourceVersionId" />
      
      <property name="Duration" not-null="false" />
      <property name="FileName" not-null="true" />
      <property name="AudioType" not-null="true" />
      <property name="MimeType" not-null="true" />
    </joined-subclass>

    <joined-subclass table="TrackResource" name="TrackResource" >
      <key column="ResourceVersionId" />

      <property name="Name" not-null="true" />
      <property name="Text" not-null="false" />
      <property name="Position" not-null="true" />
      <many-to-one name="ResourceChapter" class="Resource" lazy="proxy" />
      <many-to-one name="ResourceBeginningPage" class="Resource" lazy="proxy" />
    </joined-subclass>

    <joined-subclass table="ChapterResource" name="ChapterResource" >
      <key column="ResourceVersionId" />
      
      <property name="Name" not-null="true" />
      <property name="Position" not-null="true" />
      <many-to-one name="ResourceBeginningPage" class="Resource" lazy="proxy" />
    </joined-subclass>

    <joined-subclass table="HeadwordResource" name="HeadwordResource" >
      <key column="ResourceVersionId" />
      
      <property name="ExternalId" not-null="true" />
      <property name="DefaultHeadword" not-null="true" />
      <property name="Sorting" not-null="true" />
      <many-to-one name="BookVersion" class="BookVersionResource" lazy="proxy" />

      <bag name="HeadwordItems">
        <key column="HeadwordResource" />
        <one-to-many class="HeadwordItem" />
      </bag>
    </joined-subclass>

    <joined-subclass table="BinaryResource" name="BinaryResource" >
      <key column="ResourceVersionId" />

      <property name="Name" not-null="true" />
      <property name="FileName" not-null="true" />
    </joined-subclass>

    <joined-subclass table="BookVersionResource" name="BookVersionResource" >
      <key column="ResourceVersionId" />

      <property name="ExternalId" />
    </joined-subclass>

  </class>

  <sql-query name="GetHeadwordRowNumber">
    <![CDATA[
SELECT TOP (1) __hibernate_sort_row FROM
 (
   select headwordre0_.ResourceVersionId as col_0_0_,
          min(headwordre0_.Sorting) as col_1_0_,
          min(headwordre0_.DefaultHeadword) as DefaultHeadword,
          ROW_NUMBER() OVER(ORDER BY min(headwordre0_.Sorting)) as __hibernate_sort_row
    from HeadwordResource headwordre0_
      inner join [ResourceVersion] headwordre0_1_ on headwordre0_.ResourceVersionId=headwordre0_1_.Id
      inner join [Resource] resource1_ on headwordre0_1_.Resource=resource1_.Id
      inner join [HeadwordItem] headwordit2_ on headwordre0_.ResourceVersionId=headwordit2_.HeadwordResource
    where resource1_.LatestVersion=headwordre0_.ResourceVersionId and (resource1_.Project in 
    (
      select distinct project5_.Id
        from MetadataResource metadatare3_ 
        inner join [ResourceVersion] metadatare3_1_ on metadatare3_.ResourceVersionId=metadatare3_1_.Id
    	  inner join [Resource] resource4_ on metadatare3_1_.Resource=resource4_.Id
    	  inner join [Project] project5_ on resource4_.Project=project5_.Id
    	  inner join [Snapshot] snapshot6_ on project5_.LatestPublishedSnapshot=snapshot6_.Id
    	  inner join Snapshot_BookType booktypes7_ on snapshot6_.Id=booktypes7_.Snapshot
    	  inner join [BookType] booktype8_ on booktypes7_.BookType=booktype8_.Id
        where metadatare3_.ResourceVersionId=resource4_.LatestVersion and booktype8_.Type=:bookType
     ))
	   group by headwordre0_.ResourceVersionId
 ) as query
 where query.DefaultHeadword like :query 
 ORDER BY query.__hibernate_sort_row;
    ]]>
  </sql-query>
  <sql-query name="GetHeadwordRowNumberByProject">
    <![CDATA[
SELECT TOP (1) __hibernate_sort_row FROM
 (
   select headwordre0_.ResourceVersionId as col_0_0_,
          min(headwordre0_.Sorting) as col_1_0_,
          min(headwordre0_.DefaultHeadword) as DefaultHeadword,
          ROW_NUMBER() OVER(ORDER BY min(headwordre0_.Sorting)) as __hibernate_sort_row
    from HeadwordResource headwordre0_
      inner join [ResourceVersion] headwordre0_1_ on headwordre0_.ResourceVersionId=headwordre0_1_.Id
      inner join [Resource] resource1_ on headwordre0_1_.Resource=resource1_.Id
      inner join [HeadwordItem] headwordit2_ on headwordre0_.ResourceVersionId=headwordit2_.HeadwordResource
    where resource1_.LatestVersion=headwordre0_.ResourceVersionId and (resource1_.Project in 
    (
      select distinct project5_.Id
        from MetadataResource metadatare3_ 
        inner join [ResourceVersion] metadatare3_1_ on metadatare3_.ResourceVersionId=metadatare3_1_.Id
    	  inner join [Resource] resource4_ on metadatare3_1_.Resource=resource4_.Id
    	  inner join [Project] project5_ on resource4_.Project=project5_.Id
    	  inner join [Snapshot] snapshot6_ on project5_.LatestPublishedSnapshot=snapshot6_.Id
    	  inner join Snapshot_BookType booktypes7_ on snapshot6_.Id=booktypes7_.Snapshot
    	  inner join [BookType] booktype8_ on booktypes7_.BookType=booktype8_.Id
        where metadatare3_.ResourceVersionId=resource4_.LatestVersion
          and booktype8_.Type=:bookType
          and (project5_.Id in (:projectIds))
     ))
	   group by headwordre0_.ResourceVersionId
 ) as query
 where query.DefaultHeadword like :query 
 ORDER BY query.__hibernate_sort_row;
    ]]>
  </sql-query>
  <sql-query name="GetHeadwordRowNumberByProjectAndCategory">
    <![CDATA[
SELECT TOP (1) __hibernate_sort_row FROM
 (
   select headwordre0_.ResourceVersionId as col_0_0_,
          min(headwordre0_.Sorting) as col_1_0_,
          min(headwordre0_.DefaultHeadword) as DefaultHeadword,
          ROW_NUMBER() OVER(ORDER BY min(headwordre0_.Sorting)) as __hibernate_sort_row
    from HeadwordResource headwordre0_
      inner join [ResourceVersion] headwordre0_1_ on headwordre0_.ResourceVersionId=headwordre0_1_.Id
      inner join [Resource] resource1_ on headwordre0_1_.Resource=resource1_.Id
      inner join [HeadwordItem] headwordit2_ on headwordre0_.ResourceVersionId=headwordit2_.HeadwordResource
    where resource1_.LatestVersion=headwordre0_.ResourceVersionId and (resource1_.Project in 
    (
      select distinct project5_.Id
        from MetadataResource metadatare3_ 
        inner join [ResourceVersion] metadatare3_1_ on metadatare3_.ResourceVersionId=metadatare3_1_.Id
    	  inner join [Resource] resource4_ on metadatare3_1_.Resource=resource4_.Id
    	  inner join [Project] project5_ on resource4_.Project=project5_.Id
    	  inner join [Snapshot] snapshot6_ on project5_.LatestPublishedSnapshot=snapshot6_.Id
    	  inner join Snapshot_BookType booktypes7_ on snapshot6_.Id=booktypes7_.Snapshot
    	  inner join [BookType] booktype8_ on booktypes7_.BookType=booktype8_.Id
        where metadatare3_.ResourceVersionId=resource4_.LatestVersion
          and booktype8_.Type=:bookType
          and (project5_.Id in (select project9_.Id
              from [Project] project9_
              inner join Project_Category categories10_ on project9_.Id=categories10_.Project
              inner join [Category] category11_ on categories10_.Category=category11_.Id where category11_.Id in (:categoryIds))
            or project5_.Id in (:projectIds)
          )
     ))
	   group by headwordre0_.ResourceVersionId
 ) as query
 where query.DefaultHeadword like :query 
 ORDER BY query.__hibernate_sort_row;
    ]]>
  </sql-query>
</hibernate-mapping>